<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Main Trials</title>
  <link rel="stylesheet" href="styles.css">
  <script src="data_manager.js"></script>
</head>
<body>
  <h1>Main Trial</h1>
  <div class="video-container" id="mainTrialVideoContainer">
    <video id="mainTrialVideo" width="640" height="360">
      <source src="videos/P1E.mp4" type="video/mp4">
    </video>
  </div>
  <button id="startExperiment">Start Experiment</button>
  <button id="finishExperiment" style="display: none;">Finish Experiment</button>

<div class="attention-check-container" id="attentionCheckContainer" style="display: none;">
  <div class="attention-check-instructions" id="attentionCheckInstructions" style="display: none;">
    <p>Pay attention to the bouncing balls and follow the instructions.</p>
  </div>
  <!-- Add the rest of the attention check HTML code here -->
</div>


  <script>
    let currentVideoIndex = 0;
    const mainTrialVideoContainer = document.getElementById("mainTrialVideoContainer");
    const mainTrialVideo = document.getElementById("mainTrialVideo");
    const startExperimentButton = document.getElementById("startExperiment");
    const finishExperimentButton = document.getElementById("finishExperiment");
    let videoStartTime = 0;

    document.addEventListener("keydown", function (event) {
      if (event.code === "Space") {
        const currentTime = new Date().getTime();
        const videoTime = mainTrialVideo.currentTime;
        const relativeTime = currentTime - videoStartTime;
        console.log("Spacebar pressed at:", currentTime, "Video time:", videoTime, "Relative time:", relativeTime);
        mainTrialVideoContainer.style.borderColor = "red";

        // Record the reaction time, trial ID, video time, relative time, and other necessary data here
        dataManager.addData(currentVideoIndex, "keydown", currentTime, videoTime, relativeTime);
      }
    });

    document.addEventListener("keyup", function (event) {
      if (event.code === "Space") {
        mainTrialVideoContainer.style.borderColor = "black";
        const currentTime = new Date().getTime();
        const videoTime = mainTrialVideo.currentTime;
        const relativeTime = currentTime - videoStartTime;
        dataManager.addData(currentVideoIndex, "keyup", currentTime, videoTime, relativeTime);
      }
    });

  
    const videoSources = [
  "videos/P1E.mp4",
  "videos/S1U.mp4",
  "attention_check_1",
  "videos/P3U.mp4",
  "videos/S5E.mp4",
  "attention_check_2",
  "videos/S3E.mp4",
  "videos/P4U.mp4",
  "attention_check_3",
  "videos/P2E.mp4",
  "videos/S4U.mp4",
];

    let loopCounter = 0;
    const maxLoops = 1;

    mainTrialVideo.src = videoSources[currentVideoIndex];

    mainTrialVideo.addEventListener("playing", function() {
      videoStartTime = new Date().getTime();
      console.log("Video started playing at:", videoStartTime);
      // Record the start time of the video, trial ID, and other necessary data here
      dataManager.addData(currentVideoIndex, "video_start", videoStartTime);
    });
    
    
    function nextVideo() {
  currentVideoIndex++;

  if (currentVideoIndex >= videoSources.length) {
    // Proceed to the next part of the experiment (e.g., debrief)
    finishExperimentButton.style.display = "block"; // Display the finish button
    return;
  }

  const videoSource = videoSources[currentVideoIndex];

  if (videoSource.startsWith("attention_check")) {
    // Call the attention check function with the corresponding index
    const attentionCheckIndex = parseInt(videoSource.split("_")[2], 10);
    startAttentionCheck(attentionCheckIndex, () => {
      console.log("Attention check completed. Advancing to the next video.");
      nextVideo();
    });
  } else {
    mainTrialVideo.src = videoSource;
    mainTrialVideo.load();
    mainTrialVideo.play();
  }
}

    
//    function nextVideo() {
//  currentVideoIndex++;
//  if (currentVideoIndex >= videoSources.length) {
//    currentVideoIndex = 0;
//    loopCounter++;
//
//    if (loopCounter >= maxLoops) {
//      // Proceed to the next part of the experiment (e.g., debrief)
//      finishExperimentButton.style.display = "block"; // Display the finish button
//      return;
//    }
//  }

mainTrialVideo.src = videoSources[currentVideoIndex];
  mainTrialVideo.load();
  mainTrialVideo.play();
}

mainTrialVideo.addEventListener("ended", function() {
      console.log("Video ended. Advancing to next video.");
      nextVideo();
    });

    startExperimentButton.addEventListener("click", function() {
  startExperimentButton.style.display = "none";
  mainTrialVideo.play();
});

finishExperimentButton.addEventListener("click", function () {
  // Perform any necessary actions, such as redirecting the user to a different page
  console.log("Experiment finished");

  // Generate the CSV file
  const data = dataManager.getData(); // Replace with your actual data retrieving function or variable
  const csvData = convertToCSV(data);
  const blob = new Blob([csvData], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  // Create a download link and click it
  const link = document.createElement("a");
  link.href = url;
  link.download = "experiment_results.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});
    
 function startAttentionCheck(index, callback) {
  // Hide the mainTrialVideo and show the attention check animation
  mainTrialVideo.style.display = "none";
  // Replace the following line with the actual code to display the attention check animation
  const attentionCheckContainer = document.getElementById("attentionCheckContainer");
  attentionCheckContainer.style.display = "block";

  // After the attention check trial is finished, hide the attention check animation and show the mainTrialVideo
  // Replace the following setTimeout with the actual code to handle the end of the attention check trial
  setTimeout(() => {
    // Hide the attention check animation and show the mainTrialVideo
    attentionCheckContainer.style.display = "none";
    mainTrialVideo.style.display = "block";

    // Call the provided callback function
    callback();
  }, 5000); // Replace 5000 with the actual duration of the attention check trial
}

  </script>
</body>
</html>
